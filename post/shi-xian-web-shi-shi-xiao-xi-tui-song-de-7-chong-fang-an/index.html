<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
<title>
    Jobs.Lee&#39;s Blog
</title>
<!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script><![endif]-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<meta name="author" content="Jobs.Lee">
<meta name="description" content="仰望星空">
<meta name="keywords" content="">
<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
<link rel="stylesheet" href="https://jobslee0.github.io/styles/main.css" />
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/css/style.min.css" />
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/tocbot.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/script.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/icon.min.js"></script>
        
            <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/Card/prism.min.js"></script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/css/Card/prism.min.css" />
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css">
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js"></script>
            
                <!--点击特效-->
                <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/love.min.js"></script>
                
                        <!--CDN样式-->
                        <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/hit-kounter-lc-0.3.0.js"></script>
                        <script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
                        
                            <script>
                                (function() {
                                    var bp = document.createElement('script');
                                    var curProtocol = window.location.protocol.split(':')[0];
                                    if (curProtocol === 'https') {
                                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                                    } else {
                                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                                    }
                                    var s = document.getElementsByTagName("script")[0];
                                    s.parentNode.insertBefore(bp, s);
                                })();
                            </script>
                            
                                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-253487508-1"></script>
                                <script>
                                    window.dataLayer = window.dataLayer || [];

                                    function gtag() {
                                        dataLayer.push(arguments);
                                    }
                                    gtag('js', new Date());
                                    gtag('config', 'UA-253487508-1');
                                </script>
                                
</head>

<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="https://jobslee0.github.io">
                    Jobs.Lee&#39;s Blog
                </a>
            </div>
            <div id="tp-weather-widget"></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/">
                        首页
                    </a>
                    
                    <a class="menu-item" href="/archives">
                        归档
                    </a>
                    
                    <a class="menu-item" href="/tags">
                        标签
                    </a>
                    
                    <a class="menu-item" href="/post/about">
                        关于
                    </a>
                    
                        <input id="switch_default" type="checkbox" class="switch_default">
                        <label for="switch_default" class="toggleBtn"></label>
            </div>
            <form id="gridea-search-form" data-update="1696861043893" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
            </form>
        </div>
    </nav>

    
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="https://jobslee0.github.io">
                            Jobs.Lee&#39;s Blog
                        </a>
                        <!--en-->
                        <a id="mobile-toggle-theme-en" class="a en">&nbsp;Dark</a>
                        <!--zh-->
                        <a id="mobile-toggle-theme-zh" class="a zh">&nbsp;&#x6697;&#x9ED1;</a>
                    </div>
                    <form id="gridea-search-form" data-update="1696861043893" action="/search/index.html">
                        <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
                    </form>
                    <!--en-->
                    <div class="menu-toggle" id="menu-toggle-en" onclick="mobileBtn()">&#9776; Menu</div>
                    <!--zh-->
                    <div class="menu-toggle" id="menu-toggle-zh" onclick="mobileBtn()">&#9776; &#x83DC;&#x5355;</div>

                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="/">
                            首页
                        </a>
                        
                        <a class="menu-item" href="/archives">
                            归档
                        </a>
                        
                        <a class="menu-item" href="/tags">
                            标签
                        </a>
                        
                        <a class="menu-item" href="/post/about">
                            关于
                        </a>
                        
                </div>
            </div>
        </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementById("menu-toggle-en");
        var toggleMenu_zh = document.getElementById("menu-toggle-zh");

        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.display != "none") {
            if (toggleMenu.classList.contains("active")) {
                toggleMenu.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu.classList.add("active")
                mobileMenu.classList.add("active")
            }
        } else if (toggleMenu_zh.display != "none") {
            if (toggleMenu_zh.classList.contains("active")) {
                toggleMenu_zh.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu_zh.classList.add("active")
                mobileMenu.classList.add("active")
            }
        }

    }
</script>

            <div class="main">
                <div class="container">
                    <article class="post-wrap">
                        <header class="post-header">
                            <h1 class="post-title">
                                实现web实时消息推送的7种方案
                            </h1>
                            
                                    <!--zh-->
                                    <div class="post-meta zh">
                                        &#x4F5C;&#x8005;:
                                        <a itemprop="author" rel="author" href="/">
                                            Jobs.Lee's Blog
                                        </a>
                                        <span class="post-time">&#x65E5;&#x671F;: <a href="#">2023-01-10</a></span>
                                        <span class="post-readtime">&#x9605;&#x8BFB;&#x65F6;&#x95F4;:<a
                                    href="#">16.8
                                    &#x5206;&#x949F;</a></span>
                                        <span class="post-words">&#x5B57;&#x6570;:<a href="#">4312</a></span>
                                        
                                            <span class="post-category">&#x5206;&#x7C7B;:
                                
                                <a href="https://jobslee0.github.io/tag/gejMJQ-Ih/">后端</a>
                                
                                <a href="https://jobslee0.github.io/tag/OzXeV0l4le/">转载收藏</a>
                                
                            </span>
                                            
                                                阅读量:
                                                <span data-hk-page="current"> - </span>
                                                
                                    </div>
                                    
                        </header>
                        
                        <div class="post-content">
                            <blockquote>
<p>原文链接：https://juejin.cn/post/7122014462181113887</p>
</blockquote>
<figure data-type="image" tabindex="1"><img src="assets/7ba8b7af19d043478760ff54f5c8e984tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-salefu3.awebp" alt="" loading="lazy"></figure>
<h3 id="什么是消息推送push">什么是消息推送（push）</h3>
<p>推送的场景比较多，比如有人关注我的公众号，这时我就会收到一条推送消息，以此来吸引我点击打开应用。</p>
<p>消息推送(<code>push</code>)通常是指网站的运营工作等人员，通过某种工具对用户当前网页或移动设备APP进行的主动消息推送。</p>
<p>消息推送一般又分为<code>web端消息推送</code>和<code>移动端消息推送</code>。</p>
<figure data-type="image" tabindex="2"><img src="assets/7e69c90d05ad499e8bda09ab437f5a7btplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-88t8d3q.awebp" alt="" loading="lazy"></figure>
<p>上边的这种属于移动端消息推送，web端消息推送常见的诸如站内信、未读邮件数量、监控报警数量等，应用的也非常广泛。</p>
<figure data-type="image" tabindex="3"><img src="assets/ff4aeb3ac7094e0ebbcde59df46d7900tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-xb9uppp.awebp" alt="" loading="lazy"></figure>
<p>在具体实现之前，咱们再来分析一下前边的需求，其实功能很简单，只要触发某个事件（主动分享了资源或者后台主动推送消息），web页面的通知小红点就会实时的<code>+1</code>就可以了。</p>
<p>通常在服务端会有若干张消息推送表，用来记录用户触发不同事件所推送不同类型的消息，前端主动查询（拉）或者被动接收（推）用户所有未读的消息数。</p>
<figure data-type="image" tabindex="4"><img src="assets/d00335dfe01644aa86c0d81a166aa74etplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-6aevu84.awebp" alt="" loading="lazy"></figure>
<p>消息推送无非是推（<code>push</code>）和拉（<code>pull</code>）两种形式，下边我们逐个了解下。</p>
<h3 id="短轮询">短轮询</h3>
<p>轮询(<code>polling</code>)应该是实现消息推送方案中最简单的一种，这里我们暂且将轮询分为<code>短轮询</code>和<code>长轮询</code>。</p>
<p>短轮询很好理解，指定的时间间隔，由浏览器向服务器发出<code>HTTP</code>请求，服务器实时返回未读消息数据给客户端，浏览器再做渲染显示。</p>
<p>一个简单的JS定时器就可以搞定，每秒钟请求一次未读消息数接口，返回的数据展示即可。</p>
<pre><code class="language-scss">setInterval(() =&gt; {
  // 方法请求
  messageCount().then((res) =&gt; {
      if (res.code === 200) {
          this.messageCount = res.data
      }
  })
}, 1000);
复制代码
</code></pre>
<p>效果还是可以的，短轮询实现固然简单，缺点也是显而易见，由于推送数据并不会频繁变更，无论后端此时是否有新的消息产生，客户端都会进行请求，势必会对服务端造成很大压力，浪费带宽和服务器资源。</p>
<figure data-type="image" tabindex="5"><img src="assets/61b91d3f2cc3491989adf96661cd0daetplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-8r05mt8.awebp" alt="" loading="lazy"></figure>
<h3 id="长轮询">长轮询</h3>
<p>长轮询是对上边短轮询的一种改进版本，在尽可能减少对服务器资源浪费的同时，保证消息的相对实时性。长轮询在中间件中应用的很广泛，比如<code>Nacos</code>和<code>apollo</code>配置中心，消息队列<code>kafka</code>、<code>RocketMQ</code>中都有用到长轮询。</p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F94ftESkDoZI9gAGflLiGwg" title="https://mp.weixin.qq.com/s/94ftESkDoZI9gAGflLiGwg">Nacos配置中心交互模型是push还是pull？</a>一文中我详细介绍过<code>Nacos</code>长轮询的实现原理，感兴趣的小伙伴可以瞅瞅。</p>
<p>这次我使用<code>apollo</code>配置中心实现长轮询的方式，应用了一个类<code>DeferredResult</code>，它是在<code>servelet3.0</code>后经过Spring封装提供的一种异步请求机制，直意就是延迟结果。</p>
<figure data-type="image" tabindex="6"><img src="assets/bf1a7d21a567406f8c51a4a67a36be27tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-fq8s6zv.awebp" alt="" loading="lazy"></figure>
<p><code>DeferredResult</code>可以允许容器线程快速释放占用的资源，不阻塞请求线程，以此接受更多的请求提升系统的吞吐量，然后启动异步工作线程处理真正的业务逻辑，处理完成调用<code>DeferredResult.setResult(200)</code>提交响应结果。</p>
<p>下边我们用长轮询来实现消息推送。</p>
<p>因为一个ID可能会被多个长轮询请求监听，所以我采用了<code>guava</code>包提供的<code>Multimap</code>结构存放长轮询，一个key可以对应多个value。一旦监听到key发生变化，对应的所有长轮询都会响应。前端得到非请求超时的状态码，知晓数据变更，主动查询未读消息数接口，更新页面数据。</p>
<pre><code class="language-java">@Controller
@RequestMapping(&quot;/polling&quot;)
public class PollingController {

    // 存放监听某个Id的长轮询集合
    // 线程同步结构
    public static Multimap&lt;String, DeferredResult&lt;String&gt;&gt; watchRequests = Multimaps.synchronizedMultimap(HashMultimap.create());

    /**
     * 公众号：程序员小富
     * 设置监听
     */
    @GetMapping(path = &quot;watch/{id}&quot;)
    @ResponseBody
    public DeferredResult&lt;String&gt; watch(@PathVariable String id) {
        // 延迟对象设置超时时间
        DeferredResult&lt;String&gt; deferredResult = new DeferredResult&lt;&gt;(TIME_OUT);
        // 异步请求完成时移除 key，防止内存溢出
        deferredResult.onCompletion(() -&gt; {
            watchRequests.remove(id, deferredResult);
        });
        // 注册长轮询请求
        watchRequests.put(id, deferredResult);
        return deferredResult;
    }

    /**
     * 公众号：程序员小富
     * 变更数据
     */
    @GetMapping(path = &quot;publish/{id}&quot;)
    @ResponseBody
    public String publish(@PathVariable String id) {
        // 数据变更 取出监听ID的所有长轮询请求，并一一响应处理
        if (watchRequests.containsKey(id)) {
            Collection&lt;DeferredResult&lt;String&gt;&gt; deferredResults = watchRequests.get(id);
            for (DeferredResult&lt;String&gt; deferredResult : deferredResults) {
                deferredResult.setResult(&quot;我更新了&quot; + new Date());
            }
        }
        return &quot;success&quot;;
    }
复制代码
</code></pre>
<p>当请求超过设置的超时时间，会抛出<code>AsyncRequestTimeoutException</code>异常，这里直接用<code>@ControllerAdvice</code>全局捕获统一返回即可，前端获取约定好的状态码后再次发起长轮询请求，如此往复调用。</p>
<pre><code class="language-less">@ControllerAdvice
public class AsyncRequestTimeoutHandler {

    @ResponseStatus(HttpStatus.NOT_MODIFIED)
    @ResponseBody
    @ExceptionHandler(AsyncRequestTimeoutException.class)
    public String asyncRequestTimeoutHandler(AsyncRequestTimeoutException e) {
        System.out.println(&quot;异步请求超时&quot;);
        return &quot;304&quot;;
    }
}
复制代码
</code></pre>
<p>我们来测试一下，首先页面发起长轮询请求<code>/polling/watch/10086</code>监听消息更变，请求被挂起，不变更数据直至超时，再次发起了长轮询请求；紧接着手动变更数据<code>/polling/publish/10086</code>，长轮询得到响应，前端处理业务逻辑完成后再次发起请求，如此循环往复。</p>
<figure data-type="image" tabindex="7"><img src="assets/5c5d5b17c80e4384b023868fd84bd916tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-9w2l4lc.awebp" alt="" loading="lazy"></figure>
<p>长轮询相比于短轮询在性能上提升了很多，但依然会产生较多的请求，这是它的一点不完美的地方。</p>
<h3 id="iframe流">iframe流</h3>
<p>iframe流就是在页面中插入一个隐藏的<code>&lt;iframe&gt;</code>标签，通过在<code>src</code>中请求消息数量API接口，由此在服务端和客户端之间创建一条长连接，服务端持续向<code>iframe</code>传输数据。</p>
<blockquote>
<p>传输的数据通常是<code>HTML</code>、或是内嵌的<code>javascript</code>脚本，来达到实时更新页面的效果。</p>
</blockquote>
<figure data-type="image" tabindex="8"><img src="assets/f51976a5e7534d6fb9f1b4c909c337d1tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-8n7rhjx.awebp" alt="" loading="lazy"></figure>
<p>这种方式实现简单，前端只要一个<code>&lt;iframe&gt;</code>标签搞定了</p>
<pre><code class="language-css">&lt;iframe src=&quot;/iframe/message&quot; style=&quot;display:none&quot;&gt;&lt;/iframe&gt;
复制代码
</code></pre>
<p>服务端直接组装html、js脚本数据向<code>response</code>写入就行了</p>
<pre><code class="language-swift">@Controller
@RequestMapping(&quot;/iframe&quot;)
public class IframeController {
    @GetMapping(path = &quot;message&quot;)
    public void message(HttpServletResponse response) throws IOException, InterruptedException {
        while (true) {
            response.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;);
            response.setDateHeader(&quot;Expires&quot;, 0);
            response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache,no-store&quot;);
            response.setStatus(HttpServletResponse.SC_OK);
            response.getWriter().print(&quot; &lt;script type=\&quot;text/javascript\&quot;&gt;\n&quot; +
                    &quot;parent.document.getElementById('clock').innerHTML = \&quot;&quot; + count.get() + &quot;\&quot;;&quot; +
                    &quot;parent.document.getElementById('count').innerHTML = \&quot;&quot; + count.get() + &quot;\&quot;;&quot; +
                    &quot;&lt;/script&gt;&quot;);
        }
    }
}
复制代码
</code></pre>
<p>但我个人不推荐，因为它在浏览器上会显示请求未加载完，图标会不停旋转，简直是强迫症杀手。</p>
<figure data-type="image" tabindex="9"><img src="assets/c0dc4a1d08d14507aaac2eaa93bc3c8atplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-pg3z6k4.awebp" alt="" loading="lazy"></figure>
<h3 id="sse-我的方式">SSE (我的方式)</h3>
<p>很多人可能不知道，服务端向客户端推送消息，其实除了可以用<code>WebSocket</code>这种耳熟能详的机制外，还有一种服务器发送事件(<code>Server-sent events</code>)，简称<code>SSE</code>。</p>
<p><code>SSE</code>它是基于<code>HTTP</code>协议的，我们知道一般意义上的HTTP协议是无法做到服务端主动向客户端推送消息的，但SSE是个例外，它变换了一种思路。</p>
<figure data-type="image" tabindex="10"><img src="assets/5373f61c405b42b6b00747cc359258b4tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-c9589tt.awebp" alt="" loading="lazy"></figure>
<p>SSE在服务器和客户端之间打开一个单向通道，服务端响应的不再是一次性的数据包而是<code>text/event-stream</code>类型的数据流信息，在有数据变更时从服务器流式传输到客户端。</p>
<p>整体的实现思路有点类似于在线视频播放，视频流会连续不断的推送到浏览器，你也可以理解成，客户端在完成一次用时很长（网络不畅）的下载。</p>
<figure data-type="image" tabindex="11"><img src="assets/4c3bc02f163e4848aed9106758fd5d34tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-s0hyei7.awebp" alt="" loading="lazy"></figure>
<p><code>SSE</code>与<code>WebSocket</code>作用相似，都可以建立服务端与浏览器之间的通信，实现服务端向客户端推送消息，但还是有些许不同：</p>
<ul>
<li>SSE 是基于HTTP协议的，它们不需要特殊的协议或服务器实现即可工作；<code>WebSocket</code>需单独服务器来处理协议。</li>
<li>SSE 单向通信，只能由服务端向客户端单向通信；webSocket全双工通信，即通信的双方可以同时发送和接受信息。</li>
<li>SSE 实现简单开发成本低，无需引入其他组件；WebSocket传输数据需做二次解析，开发门槛高一些。</li>
<li>SSE 默认支持断线重连；WebSocket则需要自己实现。</li>
<li>SSE 只能传送文本消息，二进制数据需要经过编码后传送；WebSocket默认支持传送二进制数据。</li>
</ul>
<p><strong>SSE 与 WebSocket 该如何选择？</strong></p>
<blockquote>
<p>技术并没有好坏之分，只有哪个更合适</p>
</blockquote>
<p>SSE好像一直不被大家所熟知，一部分原因是出现了WebSockets，这个提供了更丰富的协议来执行双向、全双工通信。对于游戏、即时通信以及需要双向近乎实时更新的场景，拥有双向通道更具吸引力。</p>
<p>但是，在某些情况下，不需要从客户端发送数据。而你只需要一些服务器操作的更新。比如：站内信、未读消息数、状态更新、股票行情、监控数量等场景，<code>SEE</code>不管是从实现的难易和成本上都更加有优势。此外，SSE 具有<code>WebSockets</code>在设计上缺乏的多种功能，例如：<code>自动重新连接</code>、<code>事件ID</code>和<code>发送任意事件</code>的能力。</p>
<p>前端只需进行一次HTTP请求，带上唯一ID，打开事件流，监听服务端推送的事件就可以了</p>
<pre><code class="language-javascript">&lt;script&gt;
    let source = null;
    let userId = 7777
    if (window.EventSource) {
        // 建立连接
        source = new EventSource('http://localhost:7777/sse/sub/'+userId);
        setMessageInnerHTML(&quot;连接用户=&quot; + userId);
        /**
         * 连接一旦建立，就会触发open事件
         * 另一种写法：source.onopen = function (event) {}
         */
        source.addEventListener('open', function (e) {
            setMessageInnerHTML(&quot;建立连接。。。&quot;);
        }, false);
        /**
         * 客户端收到服务器发来的数据
         * 另一种写法：source.onmessage = function (event) {}
         */
        source.addEventListener('message', function (e) {
            setMessageInnerHTML(e.data);
        });
    } else {
        setMessageInnerHTML(&quot;你的浏览器不支持SSE&quot;);
    }
&lt;/script&gt;
复制代码
</code></pre>
<p>服务端的实现更简单，创建一个<code>SseEmitter</code>对象放入<code>sseEmitterMap</code>进行管理</p>
<pre><code class="language-java">private static Map&lt;String, SseEmitter&gt; sseEmitterMap = new ConcurrentHashMap&lt;&gt;();

/**
 * 创建连接
 *
 * @date: 2022/7/12 14:51
 * @auther: 公众号：程序员小富
 */
public static SseEmitter connect(String userId) {
    try {
        // 设置超时时间，0表示不过期。默认30秒
        SseEmitter sseEmitter = new SseEmitter(0L);
        // 注册回调
        sseEmitter.onCompletion(completionCallBack(userId));
        sseEmitter.onError(errorCallBack(userId));
        sseEmitter.onTimeout(timeoutCallBack(userId));
        sseEmitterMap.put(userId, sseEmitter);
        count.getAndIncrement();
        return sseEmitter;
    } catch (Exception e) {
        log.info(&quot;创建新的sse连接异常，当前用户：{}&quot;, userId);
    }
    return null;
}

/**
 * 给指定用户发送消息
 *
 * @date: 2022/7/12 14:51
 * @auther: 公众号：程序员小富
 */
public static void sendMessage(String userId, String message) {

    if (sseEmitterMap.containsKey(userId)) {
        try {
            sseEmitterMap.get(userId).send(message);
        } catch (IOException e) {
            log.error(&quot;用户[{}]推送异常:{}&quot;, userId, e.getMessage());
            removeUser(userId);
        }
    }
}
复制代码
</code></pre>
<p>我们模拟服务端推送消息，看下客户端收到了消息，和我们预期的效果一致。 <img src="assets/1769bd488c8e4c789da78fb10dd130c3tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-zalceeq.awebp" alt="" loading="lazy"></p>
<p><strong>注意：</strong> SSE不支持<code>IE</code>浏览器，对其他主流浏览器兼容性做的还不错。 <img src="assets/1f4fc1cd9656437bbd27166224bddbbctplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-iblarbi.awebp" alt="" loading="lazy"></p>
<h3 id="mqtt">MQTT</h3>
<p>什么是 MQTT协议？</p>
<p><code>MQTT</code> 全称(Message Queue Telemetry Transport)：一种基于发布/订阅（<code>publish</code>/<code>subscribe</code>）模式的<code>轻量级</code>通讯协议，通过订阅相应的主题来获取消息，是物联网（<code>Internet of Thing</code>）中的一个标准传输协议。</p>
<p>该协议将消息的发布者（<code>publisher</code>）与订阅者（<code>subscriber</code>）进行分离，因此可以在不可靠的网络环境中，为远程连接的设备提供可靠的消息服务，使用方式与传统的MQ有点类似。</p>
<figure data-type="image" tabindex="12"><img src="assets/9c9a57b88deb4cf9b17f6130036efa53tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-hw2sace.awebp" alt="" loading="lazy"></figure>
<p><code>TCP</code>协议位于传输层，<code>MQTT</code> 协议位于应用层，<code>MQTT</code> 协议构建于<code>TCP/IP</code>协议上，也就是说只要支持<code>TCP/IP</code>协议栈的地方，都可以使用<code>MQTT</code>协议。</p>
<p>为什么要用 MQTT协议？</p>
<p><code>MQTT</code>协议为什么在物联网（IOT）中如此受偏爱？而不是其它协议，比如我们更为熟悉的 <code>HTTP</code>协议呢？</p>
<ul>
<li>首先<code>HTTP</code>协议它是一种同步协议，客户端请求后需要等待服务器的响应。而在物联网（IOT）环境中，设备会很受制于环境的影响，比如带宽低、网络延迟高、网络通信不稳定等，显然异步消息协议更为适合<code>IOT</code>应用程序。</li>
<li><code>HTTP</code>是单向的，如果要获取消息客户端必须发起连接，而在物联网（IOT）应用程序中，设备或传感器往往都是客户端，这意味着它们无法被动地接收来自网络的命令。</li>
<li>通常需要将一条命令或者消息，发送到网络上的所有设备上。<code>HTTP</code>要实现这样的功能不但很困难，而且成本极高。</li>
</ul>
<p>具体的MQTT协议介绍和实践，这里我就不再赘述了，大家可以参考我之前的两篇文章，里边写的也都很详细了。</p>
<p>MQTT协议的介绍</p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FudFE6k9pPetIWsa6KeErrA" title="https://mp.weixin.qq.com/s/udFE6k9pPetIWsa6KeErrA">我也没想到 springboot + rabbitmq 做智能家居，会这么简单</a></p>
<p>MQTT实现消息推送</p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FU-fUGr9i1MVa4PoVyiDFCg" title="https://mp.weixin.qq.com/s/U-fUGr9i1MVa4PoVyiDFCg">未读消息（小红点），前端 与 RabbitMQ 实时消息推送实践，贼简单~</a></p>
<h3 id="websocket">Websocket</h3>
<p><code>websocket</code>应该是大家都比较熟悉的一种实现消息推送的方式，上边我们在讲SSE的时候也和websocket进行过比较。</p>
<p>WebSocket是一种在<code>TCP</code>连接上进行全双工通信的协议，建立客户端和服务器之间的通信渠道。浏览器和服务器仅需一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p>
<figure data-type="image" tabindex="13"><img src="assets/b1b07779d35f4d33afa13e23e0baeba2tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-y8e9ilu.awebp" alt="图片源于网络" loading="lazy"></figure>
<p>springboot整合websocket，先引入<code>websocket</code>相关的工具包，和SSE相比额外的开发成本。</p>
<pre><code class="language-java">&lt;!-- 引入websocket --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;
&lt;/dependency&gt;
复制代码
</code></pre>
<p>服务端使用<code>@ServerEndpoint</code>注解标注当前类为一个websocket服务器，客户端可以通过<code>ws://localhost:7777/webSocket/10086</code>来连接到WebSocket服务器端。</p>
<pre><code class="language-java">@Component
@Slf4j
@ServerEndpoint(&quot;/websocket/{userId}&quot;)
public class WebSocketServer {
    //与某个客户端的连接会话，需要通过它来给客户端发送数据
    private Session session;
    private static final CopyOnWriteArraySet&lt;WebSocketServer&gt; webSockets = new CopyOnWriteArraySet&lt;&gt;();
    // 用来存在线连接数
    private static final Map&lt;String, Session&gt; sessionPool = new HashMap&lt;String, Session&gt;();
    /**
     * 公众号：程序员小富
     * 链接成功调用的方法
     */
    @OnOpen
    public void onOpen(Session session, @PathParam(value = &quot;userId&quot;) String userId) {
        try {
            this.session = session;
            webSockets.add(this);
            sessionPool.put(userId, session);
            log.info(&quot;websocket消息: 有新的连接，总数为:&quot; + webSockets.size());
        } catch (Exception e) {
        }
    }
    /**
     * 公众号：程序员小富
     * 收到客户端消息后调用的方法
     */
    @OnMessage
    public void onMessage(String message) {
        log.info(&quot;websocket消息: 收到客户端消息:&quot; + message);
    }
    /**
     * 公众号：程序员小富
     * 此为单点消息
     */
    public void sendOneMessage(String userId, String message) {
        Session session = sessionPool.get(userId);
        if (session != null &amp;&amp; session.isOpen()) {
            try {
                log.info(&quot;websocket消: 单点消息:&quot; + message);
                session.getAsyncRemote().sendText(message);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
复制代码
</code></pre>
<p>前端初始化打开WebSocket连接，并监听连接状态，接收服务端数据或向服务端发送数据。</p>
<pre><code class="language-js">&lt;script&gt;
    var ws = new WebSocket('ws://localhost:7777/webSocket/10086');
    // 获取连接状态
    console.log('ws连接状态：' + ws.readyState);
    //监听是否连接成功
    ws.onopen = function () {
        console.log('ws连接状态：' + ws.readyState);
        //连接成功则发送一个数据
        ws.send('test1');
    }
    // 接听服务器发回的信息并处理展示
    ws.onmessage = function (data) {
        console.log('接收到来自服务器的消息：');
        console.log(data);
        //完成通信后关闭WebSocket连接
        ws.close();
    }
    // 监听连接关闭事件
    ws.onclose = function () {
        // 监听整个过程中websocket的状态
        console.log('ws连接状态：' + ws.readyState);
    }
    // 监听并处理error事件
    ws.onerror = function (error) {
        console.log(error);
    }
    function sendMessage() {
        var content = $(&quot;#message&quot;).val();
        $.ajax({
            url: '/socket/publish?userId=10086&amp;message=' + content,
            type: 'GET',
            data: { &quot;id&quot;: &quot;7777&quot;, &quot;content&quot;: content },
            success: function (data) {
                console.log(data)
            }
        })
    }
&lt;/script&gt;
复制代码
</code></pre>
<p>页面初始化建立websocket连接，之后就可以进行双向通信了，效果还不错</p>
<figure data-type="image" tabindex="14"><img src="assets/d14ebf8388b24124aa78628223e35e22tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-p5r1ehv.awebp" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="15"><img src="assets/b3edcf8db6c04ae2be453b3420f5a711tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-en9adgr.awebp" alt="" loading="lazy"></figure>
<h3 id="自定义推送">自定义推送</h3>
<p>上边我们给我出了6种方案的原理和代码实现，但在实际业务开发过程中，不能盲目的直接拿过来用，还是要结合自身系统业务的特点和实际场景来选择合适的方案。</p>
<p>推送最直接的方式就是使用第三推送平台，毕竟<strong>钱能解决的需求都不是问题</strong>，无需复杂的开发运维，直接可以使用，省时、省力、省心，像goEasy、极光推送都是很不错的三方服务商。</p>
<p>一般大型公司都有自研的消息推送平台，像我们本次实现的web站内信只是平台上的一个触点而已，短信、邮件、微信公众号、小程序凡是可以触达到用户的渠道都可以接入进来。</p>
<figure data-type="image" tabindex="16"><img src="assets/1a818218951b4bc9864bb08a955d0e2btplv-k3u1fbpfcp-zoom-in-crop-mark4536000-20230110143921-pctlq2d.awebp" alt="图片来源于网络" loading="lazy"></figure>
<p>消息推送系统内部是相当复杂的，诸如消息内容的维护审核、圈定推送人群、触达过滤拦截（推送的规则频次、时段、数量、黑白名单、关键词等等）、推送失败补偿非常多的模块，技术上涉及到大数据量、高并发的场景也很多。所以我们今天的实现方式在这个庞大的系统面前只是小打小闹。</p>

                        </div>
                        
                            <div class="post-toc">
                                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81push">什么是消息推送（push）</a></li>
<li><a href="#%E7%9F%AD%E8%BD%AE%E8%AF%A2">短轮询</a></li>
<li><a href="#%E9%95%BF%E8%BD%AE%E8%AF%A2">长轮询</a></li>
<li><a href="#iframe%E6%B5%81">iframe流</a></li>
<li><a href="#sse-%E6%88%91%E7%9A%84%E6%96%B9%E5%BC%8F">SSE (我的方式)</a></li>
<li><a href="#mqtt">MQTT</a></li>
<li><a href="#websocket">Websocket</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A8%E9%80%81">自定义推送</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                            </div>
                            
                                
                                    
                                            <!--zh-->
                                            <section class="post-copyright zh">
                                                <p class="copyright-item ">
                                                    <span>&#x4F5C;&#x8005;:</span>
                                                    <span>Jobs.Lee's Blog</span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x6C38;&#x4E45;&#x94FE;&#x63A5;:</span>
                                                    <span><a href="https://jobslee0.github.io/post/shi-xian-web-shi-shi-xiao-xi-tui-song-de-7-chong-fang-an/">https://jobslee0.github.io/post/shi-xian-web-shi-shi-xiao-xi-tui-song-de-7-chong-fang-an/</a></span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x534F;&#x8BAE;:</span>
                                                    <span>MIT License</span>
                                                </p>
                                            </section>
                                            
                                                
                                                    
                                                                    <!--Share-->
                                                                    <span style="margin-right:15px">
                        <i class="post-share"></i>
                        <span>&#x5206;&#x4EAB;:</span>
                                                                    <a title="QR 码" target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://jobslee0.github.io/post/shi-xian-web-shi-shi-xiao-xi-tui-song-de-7-chong-fang-an/"><i class="fa fa-qrcode"></i></a>
                                                                    <a title="QQ" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://jobslee0.github.io/post/shi-xian-web-shi-shi-xiao-xi-tui-song-de-7-chong-fang-an/&sharesource=qzone&title=实现web实时消息推送的7种方案&pics=https://jobslee0.github.io/images/avatar.png?v=1696861043893&summary="><i class="fa fa-qq"></i></a>
                                                                    <a title="新浪微博" target="_blank" href="https://service.weibo.com/share/share.php?url=https://jobslee0.github.io/post/shi-xian-web-shi-shi-xiao-xi-tui-song-de-7-chong-fang-an/&sharesource=weibo&title=实现web实时消息推送的7种方案 + " - " + &pic="https://jobslee0.github.io/images/avatar.png?v=1696861043893 "><i class="fa fa-weibo "></i></a>

                                                                    </span>
                                                                    
                                                                            <!--zh-->
                                                                            <section class="post-tags zh ">
                                                                                <div>
                                                                                    <span>&#x6807;&#x7B7E;:</span>
                                                                                    <span class="tag ">
                        
                        
                        <a href="https://jobslee0.github.io/tag/gejMJQ-Ih/">#
                    后端
                        </a>
                        
                        <a href="https://jobslee0.github.io/tag/OzXeV0l4le/">#
                    转载收藏
                        </a>
                        
                            
                                </span>
                                                                                </div>
                                                                                <div>
                                                                                    <a href="javascript:window.history.back();">
                        &#x8FD4;&#x56DE;</a>
                                                                                    <span>&dot;</span>
                                                                                    <a href="#">&#x4E3B;&#x9875;</a>
                                                                                </div>
                                                                            </section>

                                                                            
                                                                                <!---->
                                                                                <section class="post-nav">
                                                                                    
                                                                                        <a class="prev" rel="prev" href="https://jobslee0.github.io/post/mongodb-zhi-objectid-xiang-jie/">
                                                                                            MongoDB之ObjectId详解
                                                                                        </a>
                                                                                        
                                                                                            
                                                                                                <a class="next" rel="next" href="https://jobslee0.github.io/post/guan-yu-shi-jian-guo-ji-hua-de-yi-dian-zheng-li-zong-jie/">
                                                                                                    关于时间国际化的一点整理总结
                                                                                                </a>
                                                                                                
                                                                                </section>
                    </article>
                </div>
                
                                            
            </div>
    </div>
    </div>
    </div>
    
        <footer id="footer" class="footer">
            <div class="copyright">
                
                        
                            
                                <b id="hitokoto"></b><br>
                                
                                        <svg viewBox="0 0 1024 1024" style="margin-left: 5px;margin-right: 5px;" version="1.0" width="8" height="8" class="my-face">
            <path
                d="M863.597631 513.574282l-271.33965-140.213484L729.783667 81.926656c3.583731-7.87141 7.167462-15.742819 7.167462-25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0-39.293053 12.607055c-1.791866 1.59988-3.519736 3.19976-5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0-19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c-12.479064 25.214109-1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591-4.735645 44.604655-15.742819l480.091993-403.297753a55.547834 55.547834 0 0 0 19.646526-47.228458 61.243407 61.243407 0 0 0-32.12559-44.156688z"
                fill="#93b5cf"></path>
        </svg>
                                        Jobs.Lee&#39;s Blog &copy;Copyright
                                            <script>
                                                var date = new Date();
                                                document.write("" + date.getFullYear());
                                            </script>
                                            | Powered by
                                            <a href="https://gridea.dev" target="_blank">
                                                Gridea
                                            </a>
            </div>
            <div id="update" style="display:none;">
                on
            </div>
            
                <div id="version" style="display:none;">
                    1.7.6
                </div>
                
                    <script>
                        var port = '';
                        
                        document.write('<div id="home_path" style="display:none;">' + document.location.protocol + '//' + window.document.location.hostname + port + '</div>')
                    </script>
        </footer>
        
            <script src='https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js'></script>
            
                <script>
                    
                    
                    loadlive2d();
                    
                    
                    hitokoto();
                    
                    getStar();
                    hljs.initHighlighting();
                    console.clear();
                    
                    CheckVersion();
                    
                    var newDate = new Date();
                    newDate.setTime(1696861043893);
                    console.log(" Blog Update Time: " + newDate.toLocaleDateString());
                    console.log("\n %c \u26a1Theme:Chic Author's Blog:https://blog.itjoker.cn  Write By ITJoker  \n\n", "color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;");
                </script>
        </div>
</body>
<script>
    scroll();
</script>

</html>